name: CD

on:
  workflow_run:
    workflows: ["CI"]
    branches:
      - main
    types:
      - completed

permissions:
  actions: read
  contents: write

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # =========================
      # 1) Setup Minikube & K8s
      # =========================
      - name: Set up Kubernetes (minikube)
        run: |
          # à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ minikube
          curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          sudo install minikube-linux-amd64 /usr/local/bin/minikube
          
          # Start minikube cluster
          minikube start --driver=docker
          
          # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š
          kubectl get nodes
          kubectl config get-contexts

      - name: Create namespace
        run: kubectl create namespace organicnow --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply K8s manifests
        run: kubectl apply -f deploy/k8s-all.yaml

      # =========================
      # 2) à¹ƒà¸Šà¹‰ image à¸—à¸µà¹ˆ CI push à¹à¸¥à¹‰à¸§
      # =========================
      - name: Update Deployment Image
        run: |
          # à¸•à¸­à¸™à¸™à¸µà¹‰ CI push à¹€à¸›à¹‡à¸™ :latest à¹à¸¥à¹‰à¸§
          # à¸”à¸±à¸‡à¸™à¸±à¹‰à¸™ CD à¹à¸„à¹ˆà¸šà¸­à¸à¹ƒà¸«à¹‰ deployment à¹ƒà¸Šà¹‰ image à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
          kubectl set image deployment/backend backend=heangkung/organicnow-backend:latest -n organicnow
          kubectl set image deployment/frontend nginx=heangkung/organicnow-frontend:latest -n organicnow

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/backend -n organicnow --timeout=300s
          kubectl rollout status deployment/frontend -n organicnow --timeout=300s

      # =========================
      # 3) Ngrok + Info
      # =========================
      - name: Set up ngrok
        run: |
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar xzf ngrok-v3-stable-linux-amd64.tgz
          sudo mv ngrok /usr/local/bin/
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Start ngrok tunnel
        run: |
          ngrok http --domain=transcondylar-noncorporately-christen.ngrok-free.dev 8080 &
          NGORK_PID=$!
          echo "NGORK_PID=$NGORK_PID" >> $GITHUB_ENV
          sleep 10
          curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[] | "\(.name): \(.public_url)"' || true

      - name: Display deployment info
        run: |
          echo ""
          echo "====================================="
          echo " ğŸš€ DEPLOYMENT SUCCESSFUL"
          echo "====================================="
          echo " ğŸŒ LIVE URL: https://transcondylar-noncorporately-christen.ngrok-free.dev"
          echo " ğŸ“¦ Kubernetes Services:"
          kubectl get svc -n organicnow
          echo " ğŸ³ Pods status:"
          kubectl get pods -n organicnow
          echo "====================================="
