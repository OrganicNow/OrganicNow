name: CD

on:
  workflow_dispatch:
  push:
    branches: [ main ]


jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: ${{ always() && github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Kubernetes (minikube)
        run: |
          # à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ minikube
          curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          sudo install minikube-linux-amd64 /usr/local/bin/minikube
          
          # Start minikube cluster
          minikube start --driver=docker
          
          # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š
          kubectl get nodes
          kubectl config get-contexts

      - name: Create namespace
        run: kubectl create namespace organicnow --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply K8s manifests
        run: kubectl apply -f deploy/k8s-all.yaml

      - name: Update Deployment Image
        run: |
          kubectl set image deployment/backend backend=heangkung/organicnow-backend:latest -n organicnow
          kubectl set image deployment/frontend nginx=heangkung/organicnow-frontend:latest -n organicnow

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/backend -n organicnow --timeout=300s
          kubectl rollout status deployment/frontend -n organicnow --timeout=300s

      - name: Set up ngrok
        run: |
          # à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ ngrok
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar xzf ngrok-v3-stable-linux-amd64.tgz
          sudo mv ngrok /usr/local/bin/
          
          # à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² auth token (à¸•à¹‰à¸­à¸‡à¸¡à¸µ NGROK_AUTH_TOKEN à¹ƒà¸™ GitHub Secrets)
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Start ngrok tunnel
        run: |
          # Start ngrok à¹ƒà¸™ background
          ngrok http --domain=transcondylar-noncorporately-christen.ngrok-free.dev 8080 &
          NGORK_PID=$!
          echo "NGORK_PID=$NGORK_PID" >> $GITHUB_ENV
          
          # à¸£à¸­à¹ƒà¸«à¹‰ ngrok start
          sleep 10
          
          # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š tunnels
          curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[] | "\(.name): \(.public_url)"' || true

      - name: Display deployment info
        run: |
          echo ""
          echo "====================================="
          echo " ğŸš€ DEPLOYMENT SUCCESSFUL"
          echo "====================================="
          echo " ğŸŒ LIVE URL: https://transcondylar-noncorporately-christen.ngrok-free.dev"
          echo " ğŸ“¦ Kubernetes Services:"
          kubectl get svc -n organicnow
          echo " ğŸ³ Pods status:"
          kubectl get pods -n organicnow
          echo "====================================="